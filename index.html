<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
    <div class="file-drop-area" id="fileDropArea">
        <div>
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
            <div>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
        </div>
    </div>

    <!-- èªè¨¼ç”»é¢ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button class="btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="btn btn-secondary" onclick="showSignupForm()">æ–°è¦ç™»éŒ²</button>
            </div>
            <div id="signupForm" class="hidden">
                <div class="form-group">
                    <label for="signupEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="signupPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <button class="btn" onclick="signup()">æ–°è¦ç™»éŒ²</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</button>
            </div>
            <div id="authError" class="error-message"></div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
    <div class="container chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">ãƒãƒ£ãƒƒãƒˆ</div>
            <div class="header-actions">
                <button class="header-btn" onclick="showMap()">ğŸ—ºï¸ ãƒãƒƒãƒ—</button>
                <button class="header-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>

        <div class="message-input-container">
            <div class="file-preview-container" id="filePreviewContainer"></div>
            <div class="message-input-wrapper">
                <textarea
                    id="messageInput"
                    class="message-input"
                    placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                    rows="1"
                    onkeydown="handleMessageKeydown(event)"
                ></textarea>
                <div class="input-actions">
                    <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,text/*,application/pdf" class="hidden">
                    <button class="action-btn secondary" onclick="document.getElementById('fileInput').click()" title="ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜">ğŸ“</button>
                    <button class="action-btn" onclick="sendMessage()" title="é€ä¿¡">ğŸ“¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒƒãƒ—ç”»é¢ -->
    <div class="map-container" id="mapContainer">
        <div class="map-header">
            <div class="chat-title">ä½ç½®æƒ…å ±ãƒãƒƒãƒ—</div>
            <div class="header-actions">
                <div class="map-style-dropdown">
                    <button class="header-btn dropdown-toggle" onclick="toggleMapStyleDropdown()" id="mapStyleBtn">
                        <span id="currentStyleText">ğŸŒ OSM</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="dropdown-menu" id="mapStyleDropdown">
                        <div class="dropdown-item" onclick="selectMapStyle('osm')">
                            <span class="style-icon">ğŸŒ</span>
                            <span class="style-name">OSM</span>
                        </div>
                        <div class="dropdown-item" onclick="selectMapStyle('gsi')">
                            <span class="style-icon">ğŸ—ºï¸</span>
                            <span class="style-name">åœ°ç†é™¢åœ°å›³</span>
                        </div>
                        <div class="dropdown-item" onclick="selectMapStyle('satellite')">
                            <span class="style-icon">ğŸ›°ï¸</span>
                            <span class="style-name">èˆªç©ºå†™çœŸ</span>
                        </div>
                        <div class="dropdown-item" onclick="selectMapStyle('vector')">
                            <span class="style-icon">ğŸ”·</span>
                            <span class="style-name">ãƒ™ã‚¯ã‚¿åœ°å›³</span>
                        </div>
                    </div>
                </div>
                <button class="header-btn" onclick="toggleOverlayPanel()">ğŸ“Š ä¸»é¡Œå›³</button>
                <button class="header-btn" onclick="hideMap()">âœ• é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <!-- ä¸»é¡Œå›³ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¶å¾¡ãƒ‘ãƒãƒ« -->
        <div class="overlay-controls hidden" id="overlayControls">
            <div class="overlay-panel">
                <div class="overlay-title">ä¸»é¡Œå›³</div>
                <div class="overlay-item">
                    <label class="overlay-checkbox">
                        <input type="checkbox" id="floodOverlay" onchange="toggleFloodOverlay(this.checked)">
                        <span class="checkmark"></span>
                        <span class="overlay-label">æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸ</span>
                    </label>
                    <button class="legend-btn" onclick="showFloodLegend()" title="å‡¡ä¾‹ã‚’è¡¨ç¤º">
                        ğŸ“Š
                    </button>
                </div>
                <div class="overlay-item">
                    <label class="overlay-checkbox">
                        <input type="checkbox" id="internalFloodOverlay" onchange="toggleInternalFloodOverlay(this.checked)">
                        <span class="checkmark"></span>
                        <span class="overlay-label">å†…æ°´ï¼ˆé›¨æ°´å‡ºæ°´ï¼‰æµ¸æ°´æƒ³å®šåŒºåŸŸ</span>
                    </label>
                    <button class="legend-btn" onclick="showInternalFloodLegend()" title="å‡¡ä¾‹ã‚’è¡¨ç¤º">
                        ğŸ“Š
                    </button>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- æ´ªæ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="legend-modal" id="legendModal">
        <div class="legend-content">
            <div class="legend-header">
                <h3>æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸ å‡¡ä¾‹</h3>
                <button class="legend-close" onclick="hideLegend()">âœ•</button>
            </div>
            <div class="legend-body">
                <img src="https://disaportal.gsi.go.jp/hazardmapportal/hazardmap/copyright/img/shinsui_legend3.png"
                     alt="æ´ªæ°´æµ¸æ°´æƒ³å®šåŒºåŸŸå‡¡ä¾‹" class="legend-image">
                <div class="legend-description">
                    <p>â€» ã“ã®æµ¸æ°´æƒ³å®šåŒºåŸŸå›³ã¯ã€æƒ³å®šã—å¾—ã‚‹æœ€å¤§è¦æ¨¡ã®é™é›¨ã«ã‚ˆã‚Šæµ¸æ°´ãŒæƒ³å®šã•ã‚Œã‚‹åŒºåŸŸã¨æ°´æ·±ã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚</p>
                    <p>â€» ãƒ‡ãƒ¼ã‚¿æä¾›ï¼šå›½åœŸåœ°ç†é™¢</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å†…æ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="legend-modal" id="internalFloodLegendModal">
        <div class="legend-content">
            <div class="legend-header">
                <h3>å†…æ°´ï¼ˆé›¨æ°´å‡ºæ°´ï¼‰æµ¸æ°´æƒ³å®šåŒºåŸŸ å‡¡ä¾‹</h3>
                <button class="legend-close" onclick="hideInternalFloodLegend()">âœ•</button>
            </div>
            <div class="legend-body">
                <img src="https://disaportal.gsi.go.jp/hazardmapportal/hazardmap/copyright/img/naisui_legend.png"
                     alt="å†…æ°´æµ¸æ°´æƒ³å®šåŒºåŸŸå‡¡ä¾‹" class="legend-image">
                <div class="legend-description">
                    <p>â€» ã“ã®æµ¸æ°´æƒ³å®šåŒºåŸŸå›³ã¯ã€æƒ³å®šã—å¾—ã‚‹æœ€å¤§è¦æ¨¡ã®é™é›¨ã«ã‚ˆã‚Šå†…æ°´æ°¾æ¿«ãŒæƒ³å®šã•ã‚Œã‚‹åŒºåŸŸã¨æ°´æ·±ã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚</p>
                    <p>â€» ãƒ‡ãƒ¼ã‚¿æä¾›ï¼šå›½åœŸåœ°ç†é™¢</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="env.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let messagesListener = null;
        let selectedFiles = [];
        let map = null;
        let markers = [];
        let currentMapStyle = 'osm'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«
        let floodOverlayLayer = null; // æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤
        let internalFloodOverlayLayer = null; // å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤

        // ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
        // æ³¨æ„: ãƒ™ã‚¯ã‚¿ã‚¿ã‚¤ãƒ«ã¯å®Ÿé¨“çš„æ©Ÿèƒ½ã®ãŸã‚ã€ã¾ãšã¯ãƒ©ã‚¹ã‚¿ã‚¿ã‚¤ãƒ«ã§ç¢ºå®Ÿã«å‹•ä½œç¢ºèª
        const mapStyles = {
            osm: {
                name: 'OSM',
                icon: 'ğŸŒ',
                style: 'https://tile.openstreetmap.jp/styles/maptiler-basic-ja/style.json'
            },
            gsi: {
                name: 'åœ°ç†é™¢åœ°å›³',
                icon: 'ğŸ—ºï¸',
                style: {
                    version: 8,
                    sources: {
                        'gsi-standard': {
                            type: 'raster',
                            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Â© <a href="https://www.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>',
                            minzoom: 2,
                            maxzoom: 18
                        }
                    },
                    layers: [{
                        id: 'gsi-standard-layer',
                        type: 'raster',
                        source: 'gsi-standard',
                        paint: {
                            'raster-opacity': 1
                        }
                    }]
                }
            },
            satellite: {
                name: 'èˆªç©ºå†™çœŸ',
                icon: 'ğŸ›°ï¸',
                style: {
                    version: 8,
                    sources: {
                        'gsi-aerial': {
                            type: 'raster',
                            tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
                            tileSize: 256,
                            attribution: 'Â© <a href="https://www.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>',
                            minzoom: 2,
                            maxzoom: 18
                        }
                    },
                    layers: [{
                        id: 'gsi-aerial-layer',
                        type: 'raster',
                        source: 'gsi-aerial',
                        paint: {
                            'raster-opacity': 1
                        }
                    }]
                }
            },
            vector: {
                name: 'ãƒ™ã‚¯ã‚¿åœ°å›³',
                icon: 'ğŸ”·',
                style: 'https://gsi-cyberjapan.github.io/gsivectortile-mapbox-gl-js/std.json'
            }
        };

        // FirebaseåˆæœŸåŒ–
        console.log('Firebase Config:', window.ENV.FIREBASE_CONFIG); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        let auth, db, storage;

        try {
            firebase.initializeApp(window.ENV.FIREBASE_CONFIG);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            console.log('FirebaseåˆæœŸåŒ–å®Œäº†');
        } catch (error) {
            console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            alert('Firebase ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showChatContainer();
                loadMessages();
            } else {
                currentUser = null;
                showAuthContainer();
            }
        });

        // èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ åˆ¶å¾¡
        window.showLoginForm = function() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            clearAuthError();
        }

        window.showSignupForm = function() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            clearAuthError();
        }

        function clearAuthError() {
            document.getElementById('authError').textContent = '';
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        window.login = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            console.log('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', email); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¨˜éŒ²ã—ãªã„ï¼‰

            if (!email || !password) {
                showAuthError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!auth) {
                showAuthError('Firebaseèªè¨¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                console.log('èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                const result = await auth.signInWithEmailAndPassword(email, password);
                console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user.uid);
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    code: error.code,
                    message: error.message,
                    email: email
                });
                showAuthError(getErrorMessage(error));
            }
        }

        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
        window.signup = async function() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!email || !password || !confirmPassword) {
                showAuthError('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (password !== confirmPassword) {
                showAuthError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                return;
            }

            if (password.length < 6) {
                showAuthError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                const result = await auth.createUserWithEmailAndPassword(email, password);
                console.log('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸ:', result.user.uid);
            } catch (error) {
                console.error('ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    code: error.code,
                    message: error.message,
                    email: email
                });
                showAuthError(getErrorMessage(error));
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.logout = async function() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showAuthError(message) {
            document.getElementById('authError').textContent = message;
        }

        // Firebase ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«å¤‰æ›
        function getErrorMessage(error) {
            console.log('Firebase Error Details:', error); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

            switch (error.code) {
                case 'auth/user-not-found':
                    return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚';
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
                case 'auth/email-already-in-use':
                    return 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                case 'auth/weak-password':
                    return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ã€‚6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                case 'auth/invalid-email':
                    return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                case 'auth/too-many-requests':
                    return 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
                case 'auth/network-request-failed':
                    return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                case 'auth/internal-error':
                    return 'å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Firebaseè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                default:
                    return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.code || 'unknown'} - ${error.message || 'è©³ç´°ä¸æ˜'}`;
            }
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showAuthContainer() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('chatContainer').style.display = 'none';
        }

        function showChatContainer() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';

            // ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’äº‹å‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆåˆå›ã®ã¿ï¼‰
            requestLocationPermission();
        }

        // ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        async function requestLocationPermission() {
            if (!navigator.geolocation) {
                console.warn('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                // ä¸€åº¦ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦è¨±å¯ã‚’æ±‚ã‚ã‚‹
                await getCurrentLocation();
                console.log('ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸ');
            } catch (error) {
                console.warn('ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ:', error.message);
                // è¨±å¯ãŒå¾—ã‚‰ã‚Œãªãã¦ã‚‚ç¶šè¡Œï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ä½ç½®æƒ…å ±ãªã—ã§é€ä¿¡ï¼‰
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text && selectedFiles.length === 0) {
                return;
            }

            try {
                const messageData = {
                    text: text,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    files: []
                };

                // è‡ªå‹•çš„ã«ä½ç½®æƒ…å ±ã‚’å–å¾—
                try {
                    if (navigator.geolocation) {
                        const position = await getCurrentLocation();
                        messageData.location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('ä½ç½®æƒ…å ±ã‚’è‡ªå‹•å–å¾—:', messageData.location);
                    }
                } catch (locationError) {
                    console.warn('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ï¼ˆç„¡è¦–ã—ã¦ç¶šè¡Œï¼‰:', locationError);
                    // ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¯ç¶šè¡Œ
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                if (selectedFiles.length > 0) {
                    for (const file of selectedFiles) {
                        const fileUrl = await uploadFile(file);
                        messageData.files.push({
                            name: file.name,
                            url: fileUrl,
                            type: file.type,
                            size: file.size
                        });
                    }
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜
                await db.collection('messages').add(messageData);

                // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                input.value = '';
                selectedFiles = [];
                updateFilePreview();
                autoResize(input);

            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);

                let errorMessage = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';

                if (error.message.includes('Firebase Storage')) {
                    errorMessage = `ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                } else if (error.message.includes('æ¨©é™')) {
                    errorMessage = error.message;
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿å­˜æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firestoreã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                }

                alert(errorMessage);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadFile(file) {
            if (file.size > window.ENV.MAX_FILE_SIZE) {
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ï¼ˆ${window.ENV.MAX_FILE_SIZE / 1024 / 1024}MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
            }

            if (!currentUser) {
                throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }

            try {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹:', file.name, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser.uid);

                const fileName = `${Date.now()}_${file.name}`;
                const fileRef = storage.ref(`uploads/${fileName}`);

                console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆ:', `uploads/${fileName}`);

                const snapshot = await fileRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', downloadURL);
                return downloadURL;

            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);

                if (error.code === 'storage/unauthorized') {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚Firebase Storageã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (error.code === 'storage/invalid-format') {
                    throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
                } else if (error.code === 'storage/invalid-argument') {
                    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                } else {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
        function loadMessages() {
            if (messagesListener) {
                messagesListener();
            }

            messagesListener = db.collection('messages')
                .orderBy('timestamp', 'asc')
                .limit(window.ENV.MESSAGE_LIMIT)
                .onSnapshot((snapshot) => {
                    const messagesContainer = document.getElementById('messagesContainer');
                    const loadingIndicator = document.getElementById('loadingIndicator');

                    loadingIndicator.style.display = 'none';

                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            displayMessage(change.doc.data());
                        }
                    });

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function displayMessage(messageData) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageData.userId === currentUser.uid ? 'own' : ''}`;

            const timestamp = messageData.timestamp ?
                messageData.timestamp.toDate().toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';

            let filesHtml = '';
            if (messageData.files && messageData.files.length > 0) {
                filesHtml = messageData.files.map(file => {
                    if (file.type.startsWith('image/')) {
                        return `
                            <div class="message-file">
                                <img src="${file.url}" alt="${file.name}" class="file-preview" onclick="window.open('${file.url}', '_blank')">
                                <div class="file-info">${file.name} (${formatFileSize(file.size)})</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="message-file">
                                <div class="file-info">
                                    ğŸ“ <a href="${file.url}" target="_blank" style="color: inherit; text-decoration: none;">
                                        ${file.name} (${formatFileSize(file.size)})
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }

            let locationHtml = '';
            if (messageData.location) {
                const lat = parseFloat(messageData.location.lat).toFixed(6);
                const lng = parseFloat(messageData.location.lng).toFixed(6);
                locationHtml = `
                    <div class="location-message" onclick="showLocationOnMap(${messageData.location.lat}, ${messageData.location.lng})">
                        <span class="location-icon">ğŸ“</span>
                        <div class="location-info">
                            <div class="location-text">ä½ç½®æƒ…å ±ã‚’è¡¨ç¤º</div>
                            <div class="location-coords">ç·¯åº¦: ${lat}, çµŒåº¦: ${lng}</div>
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span>${messageData.userEmail}</span>
                        <span>${timestamp}</span>
                    </div>
                    ${messageData.text ? `<div class="message-text">${escapeHtml(messageData.text)}</div>` : ''}
                    ${filesHtml}
                    ${locationHtml}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFileSelect(e.target.files);
        });

        function handleFileSelect(files) {
            const fileArray = Array.from(files);

            if (selectedFiles.length + fileArray.length > window.ENV.MAX_FILES_COUNT) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€å¤§${window.ENV.MAX_FILES_COUNT}å€‹ã¾ã§é¸æŠã§ãã¾ã™ã€‚`);
                return;
            }

            for (const file of fileArray) {
                if (file.size > window.ENV.MAX_FILE_SIZE) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®ã‚µã‚¤ã‚ºãŒä¸Šé™ï¼ˆ${window.ENV.MAX_FILE_SIZE / 1024 / 1024}MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
                    continue;
                }
                selectedFiles.push(file);
            }

            updateFilePreview();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateFilePreview() {
            const container = document.getElementById('filePreviewContainer');
            container.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'file-preview-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    previewDiv.appendChild(img);
                } else {
                    previewDiv.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 24px;">ğŸ“„</div>`;
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'file-remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = () => removeFile(index);
                previewDiv.appendChild(removeBtn);

                container.appendChild(previewDiv);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            document.getElementById('fileDropArea').classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.clientX === 0 && e.clientY === 0) {
                document.getElementById('fileDropArea').classList.remove('active');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('fileDropArea').classList.remove('active');

            if (e.dataTransfer.files) {
                handleFileSelect(e.dataTransfer.files);
            }
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã®åˆ¶å¾¡
        window.handleMessageKeydown = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        document.getElementById('messageInput').addEventListener('input', function() {
            autoResize(this);
        });

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ä½ç½®æƒ…å ±å…±æœ‰
        window.shareLocation = async function() {
            if (!navigator.geolocation) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                const position = await getCurrentLocation();
                const messageData = {
                    text: '',
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    location: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    },
                    files: []
                };

                await db.collection('messages').add(messageData);
            } catch (error) {
                console.error('ä½ç½®æƒ…å ±å…±æœ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: false, // ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„ã®ãŸã‚ç²¾åº¦ã‚’ä¸‹ã’ã‚‹
                    timeout: 5000, // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’5ç§’ã«çŸ­ç¸®
                    maximumAge: 5 * 60 * 1000 // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
                });
            });
        }

        // ãƒãƒƒãƒ—æ©Ÿèƒ½
        window.showMap = async function() {
            document.getElementById('mapContainer').classList.add('active');
            if (!map) {
                await initializeMap();
            } else {
                updateMapStyleButton();
            }
            updateMapMarkers();
        }

        window.hideMap = function() {
            document.getElementById('mapContainer').classList.remove('active');
        }

        async function initializeMap() {
            try {
                // å‹•çš„ã«åˆæœŸä¸­å¿ƒä½ç½®ã‚’æ±ºå®š
                const initialCenter = await getMapInitialCenter();

                map = new maplibregl.Map({
                    container: 'map',
                    style: mapStyles[currentMapStyle].style,
                    center: initialCenter,
                    zoom: window.ENV.DEFAULT_MAP_ZOOM
                });

                console.log('åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚ä¸­å¿ƒä½ç½®:', initialCenter);

                map.addControl(new maplibregl.NavigationControl());

                // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´æ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’å†è¡¨ç¤º
                map.on('styledata', () => {
                    setTimeout(() => {
                        updateMapMarkers();
                    }, 100);
                });

                // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ‡ãƒãƒƒã‚°
                map.on('error', (e) => {
                    console.error('åœ°å›³ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        error: e.error,
                        sourceId: e.sourceId,
                        type: e.type,
                        currentStyle: currentMapStyle
                    });

                    // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                    if (e.sourceId) {
                        console.error(`ã‚½ãƒ¼ã‚¹ "${e.sourceId}" ã§ã‚¨ãƒ©ãƒ¼:`, e.error);
                    }
                });

                // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹æ™‚ã®ãƒ­ã‚°
                map.on('sourcedata', (e) => {
                    if (e.sourceDataType === 'metadata') {
                        console.log(`ã‚½ãƒ¼ã‚¹ "${e.sourceId}" ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†`);
                    }
                    if (e.sourceDataType === 'content') {
                        console.log(`ã‚½ãƒ¼ã‚¹ "${e.sourceId}" ã®ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­`);
                    }
                });

                // ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®ãƒ­ã‚°
                map.on('styleimagemissing', (e) => {
                    console.warn('ã‚¹ã‚¿ã‚¤ãƒ«ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', e.id);
                });

                // ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã®å‡¦ç†
                map.on('load', () => {
                    console.log('åœ°å›³ãƒ­ãƒ¼ãƒ‰å®Œäº†:', mapStyles[currentMapStyle].name);
                });

                updateMapStyleButton();

            } catch (error) {
                console.error('åœ°å›³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleMapStyleDropdown = function() {
            const dropdown = document.getElementById('mapStyleDropdown');
            const isVisible = dropdown.classList.contains('show');

            if (isVisible) {
                hideMapStyleDropdown();
            } else {
                showMapStyleDropdown();
            }
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showMapStyleDropdown() {
            const dropdown = document.getElementById('mapStyleDropdown');
            dropdown.classList.add('show');

            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            updateDropdownSelection();

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
            setTimeout(() => {
                document.addEventListener('click', closeDropdownOnOutsideClick);
            }, 0);
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
        function hideMapStyleDropdown() {
            const dropdown = document.getElementById('mapStyleDropdown');
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeDropdownOnOutsideClick);
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        function closeDropdownOnOutsideClick(event) {
            const dropdown = document.getElementById('mapStyleDropdown');
            const button = document.getElementById('mapStyleBtn');

            if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                hideMapStyleDropdown();
            }
        }

        // ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«é¸æŠ
        window.selectMapStyle = function(styleKey) {
            if (!map || currentMapStyle === styleKey) {
                hideMapStyleDropdown();
                return;
            }

            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
            currentMapStyle = styleKey;
            map.setStyle(mapStyles[currentMapStyle].style);

            // UI ã‚’æ›´æ–°
            updateCurrentStyleDisplay();
            hideMapStyleDropdown();

            // ã‚¹ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒãƒ¼ã‚«ãƒ¼ã¨ä¸»é¡Œå›³ã‚’å†è¡¨ç¤º
            map.once('styledata', () => {
                setTimeout(() => {
                    updateMapMarkers();
                    redrawActiveOverlays(); // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ä¸»é¡Œå›³ã‚’å†æç”»
                }, 100);
            });

            console.log('ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´:', mapStyles[currentMapStyle].name);
        }

        // ç¾åœ¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
        function updateCurrentStyleDisplay() {
            const currentStyleText = document.getElementById('currentStyleText');
            if (currentStyleText) {
                const style = mapStyles[currentMapStyle];
                currentStyleText.innerHTML = `${style.icon} ${style.name}`;
            }
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        function updateDropdownSelection() {
            const items = document.querySelectorAll('#mapStyleDropdown .dropdown-item');
            items.forEach(item => {
                item.classList.remove('selected');
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${currentMapStyle}'`)) {
                    item.classList.add('selected');
                }
            });
        }

        // åˆæœŸåŒ–æ™‚ã«ã‚¹ã‚¿ã‚¤ãƒ«è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå¾“æ¥ã®updateMapStyleButtonã‚’ç½®ãæ›ãˆï¼‰
        function updateMapStyleButton() {
            updateCurrentStyleDisplay();
            updateDropdownSelection();
        }

        function updateMapMarkers() {
            if (!map) return;

            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            markers.forEach(marker => marker.remove());
            markers = [];

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            db.collection('messages')
                .where('location', '!=', null)
                .orderBy('location')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
                .then((snapshot) => {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.location) {
                            const popupContent = createMarkerPopupContent(data);

                            const marker = new maplibregl.Marker({
                                color: data.userId === currentUser?.uid ? '#667eea' : '#ff6b6b'
                            })
                                .setLngLat([data.location.lng, data.location.lat])
                                .setPopup(new maplibregl.Popup({
                                    closeButton: true,
                                    closeOnClick: false,
                                    maxWidth: '300px',
                                    className: 'custom-popup'
                                }).setHTML(popupContent))
                                .addTo(map);

                            // ãƒãƒ¼ã‚«ãƒ¼ã«ãƒ›ãƒãƒ¼åŠ¹æœã‚’è¿½åŠ 
                            const markerElement = marker.getElement();
                            markerElement.style.cursor = 'pointer';

                            const tooltipText = data.timestamp ?
                                `${data.userEmail} - ${data.timestamp.toDate().toLocaleDateString('ja-JP')}` :
                                data.userEmail;
                            markerElement.title = tooltipText;

                            // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                            markerElement.addEventListener('click', () => {
                                console.log('ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯:', {
                                    user: data.userEmail,
                                    message: data.text,
                                    location: data.location
                                });
                            });

                            markers.push(marker);
                        }
                    });

                    console.log(`ãƒãƒƒãƒ—ã«${markers.length}å€‹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                })
                .catch((error) => {
                    console.error('ãƒãƒ¼ã‚«ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
        function createMarkerPopupContent(messageData) {
            const timestamp = messageData.timestamp ?
                messageData.timestamp.toDate().toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'æ™‚åˆ»ä¸æ˜';

            const lat = parseFloat(messageData.location.lat).toFixed(6);
            const lng = parseFloat(messageData.location.lng).toFixed(6);

            let filesHtml = '';
            if (messageData.files && messageData.files.length > 0) {
                filesHtml = messageData.files.map(file => {
                    if (file.type.startsWith('image/')) {
                        return `<img src="${file.url}" alt="${file.name}" style="max-width: 100%; max-height: 150px; margin: 5px 0; border-radius: 4px;" onclick="window.open('${file.url}', '_blank')">`;
                    } else {
                        return `<div style="margin: 5px 0; padding: 5px; background: #f0f0f0; border-radius: 4px;">ğŸ“ <a href="${file.url}" target="_blank" style="color: #667eea; text-decoration: none;">${file.name}</a></div>`;
                    }
                }).join('');
            }

            return `
                <div class="map-popup-content">
                    <div class="popup-header">
                        <strong>${escapeHtml(messageData.userEmail)}</strong>
                        <div class="popup-time">${timestamp}</div>
                    </div>

                    ${messageData.text ? `
                        <div class="popup-message">
                            ${escapeHtml(messageData.text)}
                        </div>
                    ` : ''}

                    ${filesHtml}

                    <div class="popup-location">
                        ğŸ“ ${lat}, ${lng}
                    </div>
                </div>
            `;
        }

        window.showLocationOnMap = async function(lat, lng) {
            await showMap();
            setTimeout(() => {
                if (map) {
                    map.flyTo({
                        center: [lng, lat],
                        zoom: 15
                    });
                }
            }, 100);
        }

        // æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleFloodOverlay = function(checked) {
            if (!map) return;

            if (checked) {
                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’è¿½åŠ 
                try {
                    if (!map.getSource('flood-overlay')) {
                        map.addSource('flood-overlay', {
                            type: 'raster',
                            tiles: ['https://disaportaldata.gsi.go.jp/raster/01_flood_l2_shinsuishin_data/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Â© <a href="https://www.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>',
                            minzoom: 2,
                            maxzoom: 18
                        });
                    }

                    if (!map.getLayer('flood-overlay-layer')) {
                        map.addLayer({
                            id: 'flood-overlay-layer',
                            type: 'raster',
                            source: 'flood-overlay',
                            paint: {
                                'raster-opacity': 0.5 // 50%é€é
                            }
                        });
                    }

                    floodOverlayLayer = 'flood-overlay-layer';
                    console.log('æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®è¿½åŠ ã«å¤±æ•—:', error);
                }
            } else {
                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’å‰Šé™¤
                try {
                    if (map.getLayer('flood-overlay-layer')) {
                        map.removeLayer('flood-overlay-layer');
                    }
                    if (map.getSource('flood-overlay')) {
                        map.removeSource('flood-overlay');
                    }
                    floodOverlayLayer = null;
                    console.log('æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®å‰Šé™¤ã«å¤±æ•—:', error);
                }
            }
        }

        // æ´ªæ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        window.showFloodLegend = function() {
            const modal = document.getElementById('legendModal');
            modal.classList.add('show');

            // åˆæœŸä½ç½®ã‚’è¨­å®šï¼ˆç”»é¢ä¸­å¤®ã‚„ã‚„å·¦ä¸Šï¼‰
            if (!modal.hasAttribute('data-positioned')) {
                modal.style.left = '20px';
                modal.style.top = '100px';
                modal.setAttribute('data-positioned', 'true');
            }

            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            initializeDragging(modal);
        }

        // æ´ªæ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®éè¡¨ç¤º
        window.hideLegend = function() {
            const modal = document.getElementById('legendModal');
            modal.classList.remove('show');
        }

        // å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleInternalFloodOverlay = function(checked) {
            if (!map) return;

            if (checked) {
                // å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’è¿½åŠ 
                try {
                    if (!map.getSource('internal-flood-overlay')) {
                        map.addSource('internal-flood-overlay', {
                            type: 'raster',
                            tiles: ['https://disaportaldata.gsi.go.jp/raster/02_naisui_data/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Â© <a href="https://www.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>',
                            minzoom: 2,
                            maxzoom: 18
                        });
                    }

                    if (!map.getLayer('internal-flood-overlay-layer')) {
                        map.addLayer({
                            id: 'internal-flood-overlay-layer',
                            type: 'raster',
                            source: 'internal-flood-overlay',
                            paint: {
                                'raster-opacity': 0.5 // 50%é€é
                            }
                        });
                    }

                    internalFloodOverlayLayer = 'internal-flood-overlay-layer';
                    console.log('å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®è¿½åŠ ã«å¤±æ•—:', error);
                }
            } else {
                // å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’å‰Šé™¤
                try {
                    if (map.getLayer('internal-flood-overlay-layer')) {
                        map.removeLayer('internal-flood-overlay-layer');
                    }
                    if (map.getSource('internal-flood-overlay')) {
                        map.removeSource('internal-flood-overlay');
                    }
                    internalFloodOverlayLayer = null;
                    console.log('å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å±¤ã®å‰Šé™¤ã«å¤±æ•—:', error);
                }
            }
        }

        // å†…æ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        window.showInternalFloodLegend = function() {
            const modal = document.getElementById('internalFloodLegendModal');
            modal.classList.add('show');

            // åˆæœŸä½ç½®ã‚’è¨­å®šï¼ˆæ´ªæ°´å‡¡ä¾‹ã¨é‡ãªã‚‰ãªã„ã‚ˆã†å°‘ã—ãšã‚‰ã™ï¼‰
            if (!modal.hasAttribute('data-positioned')) {
                modal.style.left = '350px';
                modal.style.top = '120px';
                modal.setAttribute('data-positioned', 'true');
            }

            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            initializeDragging(modal);
        }

        // å†…æ°´å‡¡ä¾‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã®éè¡¨ç¤º
        window.hideInternalFloodLegend = function() {
            const modal = document.getElementById('internalFloodLegendModal');
            modal.classList.remove('show');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
        function initializeDragging(modal) {
            if (modal.hasAttribute('data-drag-initialized')) {
                return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
            }

            const header = modal.querySelector('.legend-header');
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            function startDrag(e) {
                isDragging = true;
                modal.classList.add('dragging');

                // ãƒã‚¦ã‚¹ã¾ãŸã¯ã‚¿ãƒƒãƒã®åº§æ¨™ã‚’å–å¾—
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;

                startX = clientX;
                startY = clientY;

                // ç¾åœ¨ã®ä½ç½®ã‚’å–å¾—
                const rect = modal.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                e.preventDefault();
            }

            function drag(e) {
                if (!isDragging) return;

                // ãƒã‚¦ã‚¹ã¾ãŸã¯ã‚¿ãƒƒãƒã®åº§æ¨™ã‚’å–å¾—
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;

                const deltaX = clientX - startX;
                const deltaY = clientY - startY;

                const newLeft = initialLeft + deltaX;
                const newTop = initialTop + deltaY;

                // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†åˆ¶é™
                const maxLeft = window.innerWidth - modal.offsetWidth;
                const maxTop = window.innerHeight - modal.offsetHeight;

                modal.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
                modal.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';

                e.preventDefault();
            }

            function endDrag() {
                isDragging = false;
                modal.classList.remove('dragging');
            }

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            header.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰
            header.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);

            modal.setAttribute('data-drag-initialized', 'true');
        }

        // ä¸»é¡Œå›³ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleOverlayPanel = function() {
            const panel = document.getElementById('overlayControls');
            panel.classList.toggle('hidden');
        }

        // æœ€å¾Œã«è¨˜éŒ²ã•ã‚ŒãŸä½ç½®ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getLastRecordedLocation() {
            try {
                const messagesRef = db.collection('messages');
                const querySnapshot = await messagesRef
                    .where('location', '!=', null)
                    .orderBy('location')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();

                if (!querySnapshot.empty) {
                    const lastMessage = querySnapshot.docs[0].data();
                    if (lastMessage.location && lastMessage.location.lat && lastMessage.location.lng) {
                        console.log('æœ€å¾Œã«è¨˜éŒ²ã•ã‚ŒãŸä½ç½®ã‚’ä½¿ç”¨:', lastMessage.location);
                        return [lastMessage.location.lng, lastMessage.location.lat];
                    }
                }
                return null;
            } catch (error) {
                console.warn('æœ€å¾Œã®ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•—:', error);
                return null;
            }
        }

        // ç¾åœ¨ä½ç½®ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆåœ°å›³åˆæœŸåŒ–ç”¨ï¼‰
        async function getCurrentLocationForMap() {
            try {
                const position = await getCurrentLocation();
                console.log('ç¾åœ¨ä½ç½®ã‚’ä½¿ç”¨:', position.coords);
                return [position.coords.longitude, position.coords.latitude];
            } catch (error) {
                console.warn('ç¾åœ¨ä½ç½®å–å¾—ã«å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨:', error);
                return window.ENV.DEFAULT_MAP_CENTER;
            }
        }

        // åœ°å›³ã®åˆæœŸè¡¨ç¤ºä½ç½®ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
        async function getMapInitialCenter() {
            // ã¾ãšæœ€å¾Œã«è¨˜éŒ²ã•ã‚ŒãŸä½ç½®ã‚’è©¦ã™
            const lastLocation = await getLastRecordedLocation();
            if (lastLocation) {
                return lastLocation;
            }

            // æœ€å¾Œã®ä½ç½®ãŒãªã„å ´åˆã¯ç¾åœ¨ä½ç½®ã‚’è©¦ã™
            const currentLocation = await getCurrentLocationForMap();
            return currentLocation;
        }

        // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ä¸»é¡Œå›³ã‚’å†æç”»ã™ã‚‹é–¢æ•°
        function redrawActiveOverlays() {
            if (!map) return;

            // æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const floodCheckbox = document.getElementById('floodOverlay');
            if (floodCheckbox && floodCheckbox.checked) {
                console.log('èƒŒæ™¯å›³å¤‰æ›´ã«ä¼´ã„æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å†æç”»');
                // ä¸€åº¦ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å†åº¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§å†æç”»
                floodCheckbox.checked = false;
                toggleFloodOverlay(false); // éè¡¨ç¤º
                setTimeout(() => {
                    floodCheckbox.checked = true;
                    toggleFloodOverlay(true); // å†è¡¨ç¤º
                }, 200);
            }

            // å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const internalFloodCheckbox = document.getElementById('internalFloodOverlay');
            if (internalFloodCheckbox && internalFloodCheckbox.checked) {
                console.log('èƒŒæ™¯å›³å¤‰æ›´ã«ä¼´ã„å†…æ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å†æç”»');
                // ä¸€åº¦ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å†åº¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§å†æç”»
                internalFloodCheckbox.checked = false;
                toggleInternalFloodOverlay(false); // éè¡¨ç¤º
                setTimeout(() => {
                    internalFloodCheckbox.checked = true;
                    toggleInternalFloodOverlay(true); // å†è¡¨ç¤º
                }, 300); // æ´ªæ°´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨é‡ãªã‚‰ãªã„ã‚ˆã†å°‘ã—é…ã‚‰ã›ã‚‹
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰ãƒ¬ã‚¹å¯¾å¿œï¼šå¤–ã‚¯ãƒªãƒƒã‚¯ã§ã¯é–‰ã˜ãªã„ã‚ˆã†ã«å¤‰æ›´
        // å‡¡ä¾‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯æ˜ç¤ºçš„ã«xãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹å¿…è¦ãŒã‚ã‚‹

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        if (window.ENV.DEBUG_MODE) {
            console.log('ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            console.log('Firebaseè¨­å®š:', window.ENV.FIREBASE_CONFIG);

            // ãƒ†ã‚¹ãƒˆç”¨ã®ä¾¿åˆ©ãªé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
            window.debugInfo = function() {
                console.log('--- ãƒ‡ãƒãƒƒã‚°æƒ…å ± ---');
                console.log('FirebaseåˆæœŸåŒ–æ¸ˆã¿:', !!auth);
                console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser);
                console.log('èªè¨¼çŠ¶æ…‹:', auth ? auth.currentUser : 'authæœªåˆæœŸåŒ–');
            };

            window.testLogin = function() {
                document.getElementById('loginEmail').value = 'test@example.com';
                document.getElementById('loginPassword').value = 'test123456';
                console.log('ãƒ†ã‚¹ãƒˆç”¨ã®èªè¨¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã—ãŸ');
            };
        }
    </script>
</body>
</html>